version: '3'

services:
  postgres:
    image: postgres
    container_name: postgres
    domainname: postgres
    build: ./migration
    ports:
      - 5432:5432
    environment:
      POSTGRES_USER: fatec
      POSTGRES_PASSWORD: fatec
      POSTGRES_DB: pi

  app:
    build: ./app
    container_name: app
    volumes:
      - ./app:/usr/src/app
    ports:
      - 5001:5000
    environment:
      POSTGRES_USER: fatec
      POSTGRES_PASSWORD: fatec
      POSTGRES_DB: pi
    depends_on: 
      - postgres

  flyway:
    image: boxfuse/flyway:5-alpine
    command: -url=jdbc:postgresql://postgres:5432/pi -schemas=public -user=fatec -password=fatec -connectRetries=10 migrate
    volumes:
      - ./migration:/flyway/sql
    depends_on:
      - app

  sonarqube:
    image: sonarqube
    container_name: sonarqubeR4u
    ports:
    - 9000:9000
    depends_on: 
    - flyway
    
  nginx:
    build: ./nginx
    container_name: nginx
    ports:
    - 6001:6001
    depends_on: 
    - sonarqube